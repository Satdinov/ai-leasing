<!-- templates/login.html -->
{% extends "base.html" %}

{% block content %}
<div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold mb-6 text-center">Вход в систему</h1>

    <form id="login-form" class="space-y-4">
        <div>
            <label for="username" class="block text-sm font-medium">Логин</label>
            <input type="text" id="username" name="username" required
                   class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
        </div>

        <div>
            <label for="password" class="block text-sm font-medium">Пароль</label>
            <input type="password" id="password" name="password" required
                   class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
        </div>

        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-md">
            Войти
        </button>

        <div class="text-center">
            <a href="/register" class="text-blue-500 hover:text-blue-600 text-sm">Нет аккаунта? Зарегистрируйтесь</a>
        </div>
    </form>

    <div id="error-message" class="mt-4 hidden p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-100 rounded-md"></div>
</div>

<script>
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorEl = document.getElementById('error-message');

    try {
        const response = await fetch('/auth/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
        });

        if (!response.ok) {
            const data = await response.json();
            errorEl.textContent = data.detail || 'Ошибка входа';
            errorEl.classList.remove('hidden');
            return;
        }

        const { access_token } = await response.json();

        // ✅ Запись токена в cookie
        document.cookie = `access_token=${access_token}; path=/; samesite=lax`;

        // ⛔️ удаляем localStorage, если он был
        localStorage.removeItem('access_token');

        window.location.href = '/dashboard';

    } catch (error) {
        errorEl.textContent = 'Ошибка соединения с сервером';
        errorEl.classList.remove('hidden');
    }
});

</script>
{% endblock %}
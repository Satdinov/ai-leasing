{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-4">Меню</h2>
        <ul class="space-y-2">
            <li><a href="/dashboard" class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Заявки</a></li>
            <li><a href="/chat" class="block px-3 py-2 rounded-md bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-100">Чат с ИИ</a></li>
            <li><a href="/upload" class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Загрузка файлов</a></li>
            <li><a href="/files" class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Мои файлы</a></li>
        </ul>
    </div>

    <div class="md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-4">Чаты</h2>
        <button onclick="createChat()" class="mb-2 w-full bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md">➕ Новый чат</button>
        <ul id="chats" class="space-y-2 max-h-[600px] overflow-y-auto"></ul>
    </div>

    <div class="md:col-span-2" id="chat-panel" style="display: none">
        <div id="messages" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 h-96 overflow-y-auto">
            <h2 class="text-xl font-semibold mb-4">Сообщения</h2>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <div class="mb-4">
                <label for="model" class="block text-sm font-medium mb-1">Модель</label>
                <select id="model" class="w-full p-2 border rounded-md dark:bg-gray-700">
                    <option value="chatgpt">ChatGPT</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="gemini">Gemini</option>
                </select>
            </div>

            <textarea id="input" rows="3" class="w-full p-2 border rounded-md dark:bg-gray-700 mb-2" placeholder="Ваш вопрос..."></textarea>
            <div class="flex gap-2">
                <button id="send-btn" onclick="sendMessage()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-md">Отправить</button>
                <button id="reset-btn" onclick="resetContext()" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md">Сбросить</button>
                <button id="cancel-btn" onclick="cancelRequest()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md hidden">Отмена</button>
            </div>
        </div>
    </div>
</div>

<script>
// Весь JavaScript для работы чата из вашего примера dashboard.html перенесен сюда
let currentChatId = null;
let currentController = null;

async function loadChats() {
    const res = await fetch('/chats');
    const chats = await res.json();
    const list = document.getElementById('chats');
    list.innerHTML = '';
    chats.forEach(chat => {
        const li = document.createElement('li');
        li.className = 'cursor-pointer px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 bg-gray-50 dark:bg-gray-900';
        li.textContent = chat.title;
        li.onclick = () => openChat(chat.id);
        list.appendChild(li);
    });
}

async function createChat() {
    const title = prompt("Введите название чата:");
    if (!title) return;
    const res = await fetch('/chats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ title })
    });
    const chat = await res.json();
    await loadChats();
    await openChat(chat.chat_id);
}

async function openChat(chatId) {
    currentChatId = chatId;
    document.getElementById('chat-panel').style.display = 'block';
    const res = await fetch(`/chats/${chatId}/messages`);
    const messages = await res.json();
    const box = document.getElementById('messages');
    box.innerHTML = '<h2 class="text-xl font-semibold mb-4">Сообщения</h2>'; // Clear previous messages
    messages.forEach(m => {
        const div = document.createElement('div');
        div.className = m.sender === 'user' ? 'text-right mb-4' : 'text-left mb-4';
        const bubble = document.createElement('div');
        bubble.className = `inline-block max-w-2/3 px-4 py-2 rounded-lg ${m.sender === 'user' ? 'bg-blue-200 dark:bg-blue-800' : 'bg-gray-200 dark:bg-gray-700'}`;
        bubble.innerHTML = `<div class="prose dark:prose-invert max-w-none">${m.html_content}</div>`;
        div.appendChild(bubble);
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
}

function cancelRequest() {
    if (currentController) {
        currentController.abort();
    }
}

async function sendMessage() {
    const input = document.getElementById('input');
    const message = input.value.trim();
    const model = document.getElementById('model').value;
    if (!message || !currentChatId) return;

    const box = document.getElementById('messages');

    // Отображаем сообщение пользователя
    const userDiv = document.createElement('div');
    userDiv.className = 'text-right mb-4';
    userDiv.innerHTML = `<div class="inline-block max-w-2/3 px-4 py-2 rounded-lg bg-blue-200 dark:bg-blue-800"><div class="prose dark:prose-invert max-w-none">${message}</div></div>`;
    box.appendChild(userDiv);
    input.value = '';
    box.scrollTop = box.scrollHeight;

    // Отображаем индикатор загрузки
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-message';
    loadingDiv.className = 'text-left mb-4';
    loadingDiv.innerHTML = `<div class="inline-block px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 animate-pulse">Печатает...</div>`;
    box.appendChild(loadingDiv);
    box.scrollTop = box.scrollHeight;

    currentController = new AbortController();
    document.getElementById('send-btn').disabled = true;
    document.getElementById('cancel-btn').classList.remove('hidden');

    try {
        const res = await fetch(`/chats/${currentChatId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ message, model }),
            signal: currentController.signal,
        });

        const data = await res.json();
        loadingDiv.remove(); // Убираем индикатор

        if (!res.ok) throw new Error(data.detail || 'Ошибка ответа сервера');

        // Отображаем ответ ИИ
        const agentDiv = document.createElement('div');
        agentDiv.className = 'text-left mb-4';
        agentDiv.innerHTML = `<div class="inline-block max-w-2/3 px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700"><div class="prose dark:prose-invert max-w-none">${data.reply_html}</div></div>`;
        box.appendChild(agentDiv);
        box.scrollTop = box.scrollHeight;

    } catch (error) {
        if (loadingDiv) loadingDiv.remove();
        alert(`Ошибка: ${error.message}`);
    } finally {
        document.getElementById('send-btn').disabled = false;
        document.getElementById('cancel-btn').classList.add('hidden');
        currentController = null;
    }
}

async function resetContext() {
    if (!currentChatId || !confirm("Вы уверены, что хотите удалить историю этого чата?")) return;
    try {
        const res = await fetch(`/chats/${currentChatId}/reset`, { method: 'POST' });
        if (!res.ok) throw new Error((await res.json()).detail);
        openChat(currentChatId); // Обновляем чат (теперь он будет пустой)
    } catch (e) {
        alert('Ошибка при сбросе контекста: ' + e.message);
    }
}

document.addEventListener('DOMContentLoaded', loadChats);
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Формирование Заявки на лизинг</h2>
            <input type="hidden" id="current-application-id" value="">
        </div>
        <form id="application-form">

            <fieldset class="border dark:border-gray-600 p-4 rounded-md mb-4">
                <legend class="px-2 font-semibold">Данные Лизингополучателя</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                    <div>
                        <label class="text-sm font-medium">Полное наименование</label>
                        <input name="lessee_company" placeholder="Общество с ограниченной ответственностью «Лизингополучатель»" class="w-full p-2 border rounded-md dark:bg-gray-700" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">ИНН</label>
                        <input name="lessee_inn" placeholder="10 или 12 цифр" class="w-full p-2 border rounded-md dark:bg-gray-700" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium">Юридический адрес</label>
                        <input name="lessee_legal_address" placeholder="Город, улица, дом" class="w-full p-2 border rounded-md dark:bg-gray-700" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium">Фактический адрес</label>
                        <input name="lessee_actual_address" placeholder="Город, улица, дом" class="w-full p-2 border rounded-md dark:bg-gray-700" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium">ФИО Директора</label>
                        <input name="lessee_director" placeholder="Иванов Иван Иванович" class="w-full p-2 border rounded-md dark:bg-gray-700" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="border dark:border-gray-600 p-4 rounded-md mb-4">
                <legend class="px-2 font-semibold">Предметы лизинга и условия</legend>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm font-medium">Общий срок лизинга (мес.)</label>
                        <input name="asset_term" type="number" placeholder="36" class="w-full p-2 border rounded-md dark:bg-gray-700" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">Аванс (%)</label>
                        <input name="advance_payment_percent" type="number" placeholder="20" class="w-full p-2 border rounded-md dark:bg-gray-700" required>
                    </div>
                </div>
                <div id="assets-list"></div>
                <button type="button" id="add-asset-btn" class="mt-4 text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md">+ Добавить предмет лизинга</button>
            </fieldset>

            <fieldset class="border dark:border-gray-600 p-4 rounded-md mb-4">
                <legend class="px-2 font-semibold">Поставщики</legend>
                <div id="suppliers-list"></div>
                <button type="button" id="add-supplier-btn" class="mt-4 text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md">+ Добавить поставщика</button>
            </fieldset>

            <fieldset class="border dark:border-gray-600 p-4 rounded-md mb-4">
                <legend class="px-2 font-semibold">Поручители</legend>
                <div id="guarantors-list"></div>
                <button type="button" id="add-guarantor-btn" class="mt-4 text-sm bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-md">+ Добавить поручителя</button>
            </fieldset>

            <fieldset class="border dark:border-gray-600 p-4 rounded-md mb-4">
                <legend class="px-2 font-semibold">Предметы залога (необязательно)</legend>
                <div id="pledges-list"></div>
                <button type="button" id="add-pledge-btn" class="mt-4 text-sm bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-3 rounded-md">+ Добавить предмет залога</button>
            </fieldset>
        </form>

        <div class="mt-6 flex flex-col sm:flex-row gap-2">
            <button id="new-app-btn" type="button" class="w-full sm:w-auto flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Новая заявка</button>
            <button id="save-app-btn" type="button" class="w-full sm:w-auto flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Сохранить</button>
            <button id="submit-form-btn" type="submit" form="application-form" class="w-full sm:w-auto flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Сформировать и скачать</button>
        </div>
        <div id="autosave-status" class="text-xs text-gray-500 mt-2 text-right h-4"></div>
    </div>

    <div class="lg:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Мои заявки</h2>
        <div id="applications-list" class="space-y-2 max-h-[600px] overflow-y-auto">
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    const applicationForm = document.getElementById('application-form');
    const applicationsListEl = document.getElementById('applications-list');
    const currentAppIdInput = document.getElementById('current-application-id');
    const saveBtn = document.getElementById('save-app-btn');
    const newBtn = document.getElementById('new-app-btn');
    const autosaveStatusEl = document.getElementById('autosave-status');

    let autosaveTimeout;

    function formatNumberWithSpaces(value) {
        if (!value) return '';
        return value.toString().replace(/\s/g, '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1 ');
    }

    function setupDynamicList(listId, buttonId, templateCallback, isOptional = false) {
        const listContainer = document.getElementById(listId);
        const addButton = document.getElementById(buttonId);

        function renumberItems() {
            const items = listContainer.querySelectorAll('.dynamic-entry');
            items.forEach((item, index) => {
                const count = index + 1;
                const header = item.querySelector('h4');
                if (header) {
                    header.textContent = header.textContent.replace(/№\d+/, `№${count}`);
                }
                item.querySelectorAll('input, select, textarea').forEach(input => {
                    const nameParts = input.name.split('_');
                    const name = nameParts.slice(0, -1).join('_');
                    input.name = `${name}_${count}`;
                });

                if (count === 1) {
                    item.classList.remove('pt-4', 'mt-4', 'border-t');
                } else {
                    item.classList.add('pt-4', 'mt-4', 'border-t');
                }
            });
        }

        listContainer.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('delete-item-btn')) {
                e.target.closest('.dynamic-entry').remove();
                renumberItems();
            }
        });

        function addFields() {
            const itemCount = listContainer.querySelectorAll('.dynamic-entry').length + 1;
            const div = document.createElement('div');
            div.className = 'dynamic-entry';
            div.innerHTML = templateCallback(itemCount);
            listContainer.appendChild(div);
            renumberItems();
        }

        addButton.addEventListener('click', addFields);

        const controller = {
            add: addFields,
            getCount: () => listContainer.querySelectorAll('.dynamic-entry').length,
            clear: () => { listContainer.innerHTML = ''; }
        };

        if (!isOptional) {
           if (listContainer.children.length === 0) controller.add();
        }

        return controller;
    }

    const deleteButtonTemplate = `<button type="button" class="delete-item-btn text-red-500 hover:text-red-700 text-sm font-bold">Удалить</button>`;

    const assetsList = setupDynamicList('assets-list', 'add-asset-btn', (count) => `
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Предмет лизинга №${count}</h4>
            ${count > 1 ? deleteButtonTemplate : ''}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-4 gap-y-2">
            <div class="md:col-span-2"><label class="text-sm font-medium">Наименование</label><input name="asset_name_${count}" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
            <div><label class="text-sm font-medium">Кол-во</label><input name="asset_quantity_${count}" type="number" value="1" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
            <div><label class="text-sm font-medium">Срок поставки (дней)</label><input name="asset_delivery_time_${count}" type="number" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
            <div class="md:col-span-4"><label class="text-sm font-medium">Общая стоимость</label><input name="asset_total_cost_${count}" placeholder="1 500 000" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
        </div>
    `);

    const suppliersList = setupDynamicList('suppliers-list', 'add-supplier-btn', (count) => `
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Поставщик №${count}</h4>
            ${count > 1 ? deleteButtonTemplate : ''}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
            <div><label class="text-sm font-medium">Наименование</label><input name="supplier_company_${count}" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
            <div><label class="text-sm font-medium">ИНН</label><input name="supplier_inn_${count}" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
            <div class="md:col-span-2"><label class="text-sm font-medium">Юр. адрес</label><input name="supplier_address_${count}" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
        </div>
    `);

    const guarantorsList = setupDynamicList('guarantors-list', 'add-guarantor-btn', (count) => `
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Поручитель №${count}</h4>
            ${count > 1 ? deleteButtonTemplate : ''}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2">
            <div><label class="text-sm font-medium">ФИО</label><input name="guarantor_full_name_${count}" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
            <div><label class="text-sm font-medium">ИНН</label><input name="guarantor_inn_${count}" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
            <div><label class="text-sm font-medium">Контакты</label><input name="guarantor_contacts_${count}" placeholder="Телефон / email" class="w-full p-2 border rounded-md dark:bg-gray-700" required></div>
        </div>
    `);

    const pledgesList = setupDynamicList('pledges-list', 'add-pledge-btn', (count) => `
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Предмет залога №${count}</h4>
            ${deleteButtonTemplate}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2">
            <div><label class="text-sm font-medium">Наименование</label><input name="pledge_name_${count}" class="w-full p-2 border rounded-md dark:bg-gray-700"></div>
            <div><label class="text-sm font-medium">Количество</label><input name="pledge_quantity_${count}" type="number" value="1" class="w-full p-2 border rounded-md dark:bg-gray-700"></div>
            <div><label class="text-sm font-medium">Рыночная стоимость (руб.)</label><input name="pledge_market_value_${count}" placeholder="1 500 000" class="w-full p-2 border rounded-md dark:bg-gray-700"></div>
        </div>
    `, true);

    const collectPayload = () => {
        const formData = new FormData(applicationForm);
        const data = Object.fromEntries(formData.entries());
        const payload = {
            lessee_company: data.lessee_company || '',
            lessee_inn: data.lessee_inn || '',
            lessee_legal_address: data.lessee_legal_address || '',
            lessee_actual_address: data.lessee_actual_address || '',
            lessee_director: data.lessee_director || '',
            asset_term: parseInt(data.asset_term) || 0,
            advance_payment_percent: parseInt(data.advance_payment_percent) || 0,
            assets: [], suppliers: [], guarantors: [], pledges: []
        };
        for (let i = 1; i <= assetsList.getCount(); i++) payload.assets.push({ name: data[`asset_name_${i}`], quantity: parseInt(data[`asset_quantity_${i}`]), delivery_time: parseInt(data[`asset_delivery_time_${i}`]), total_cost: data[`asset_total_cost_${i}`].replace(/\s/g, '') });
        for (let i = 1; i <= suppliersList.getCount(); i++) payload.suppliers.push({ company: data[`supplier_company_${i}`], inn: data[`supplier_inn_${i}`], address: data[`supplier_address_${i}`] });
        for (let i = 1; i <= guarantorsList.getCount(); i++) payload.guarantors.push({ full_name: data[`guarantor_full_name_${i}`], inn: data[`guarantor_inn_${i}`], contacts: data[`guarantor_contacts_${i}`] });
        for (let i = 1; i <= pledgesList.getCount(); i++) {
             if (data[`pledge_name_${i}`]) {
                payload.pledges.push({ name: data[`pledge_name_${i}`], quantity: parseInt(data[`pledge_quantity_${i}`]), market_value: data[`pledge_market_value_${i}`].replace(/\s/g, '') });
            }
        }
        return payload;
    };

    const populateForm = (data) => {
        applicationForm.reset();
        applicationForm.querySelector('[name="lessee_company"]').value = data.lessee_company || '';
        applicationForm.querySelector('[name="lessee_inn"]').value = data.lessee_inn || '';
        applicationForm.querySelector('[name="lessee_legal_address"]').value = data.lessee_legal_address || '';
        applicationForm.querySelector('[name="lessee_actual_address"]').value = data.lessee_actual_address || '';
        applicationForm.querySelector('[name="lessee_director"]').value = data.lessee_director || '';
        applicationForm.querySelector('[name="asset_term"]').value = data.asset_term || '';
        applicationForm.querySelector('[name="advance_payment_percent"]').value = data.advance_payment_percent || '';

        const populateList = (listName, items, listController) => {
            listController.clear();

            items.forEach((item, index) => {
                listController.add();
                const entry = document.getElementById(`${listName}-list`).children[index];
                for (const key in item) {
                    const inputName = `${listName.slice(0, -1)}_${key}_${index + 1}`;
                    const input = entry.querySelector(`[name="${inputName}"]`);
                    if (input) {
                        if (input.name.includes('total_cost') || input.name.includes('market_value')) {
                             input.value = formatNumberWithSpaces(item[key]);
                        } else {
                            input.value = item[key];
                        }
                    }
                }
            });
        };

        populateList('assets', data.assets, assetsList);
        populateList('suppliers', data.suppliers, suppliersList);
        populateList('guarantors', data.guarantors, guarantorsList);
        populateList('pledges', data.pledges, pledgesList);
    };

    const renderApplicationsList = async () => {
        try {
            const response = await fetch('/api/applications/');
            if (!response.ok) throw new Error('Не удалось загрузить список заявок');
            const applications = await response.json();

            applicationsListEl.innerHTML = '';
            if (applications.length === 0) {
                applicationsListEl.innerHTML = '<p class="text-sm text-gray-500">Сохраненных заявок нет.</p>';
                return;
            }

            applications.forEach(app => {
                const appElement = document.createElement('div');
                appElement.className = 'p-2 border rounded-md cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between items-center';
                appElement.dataset.id = app.id;
                appElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-sm">${app.title}</p>
                        <p class="text-xs text-gray-500">Обновлено: ${app.updated_at}</p>
                    </div>
                    <button data-id="${app.id}" class="delete-app-btn text-red-500 hover:text-red-700 text-xs font-bold">Удалить</button>
                `;
                applicationsListEl.appendChild(appElement);
            });
        } catch (error) {
            applicationsListEl.innerHTML = `<p class="text-red-500 text-sm">${error.message}</p>`;
        }
    };

    saveBtn.addEventListener('click', async () => {
        const payload = collectPayload();
        const appId = currentAppIdInput.value;
        const url = appId ? `/api/applications/${appId}` : '/api/applications/save';
        const method = appId ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('Ошибка сохранения');
            const result = await response.json();
            currentAppIdInput.value = result.application_id;
            await renderApplicationsList();
            autosaveStatusEl.textContent = `Сохранено в ${new Date().toLocaleTimeString()}`;
        } catch (error) {
            autosaveStatusEl.textContent = `Ошибка сохранения: ${error.message}`;
        }
    });

    newBtn.addEventListener('click', () => {
        applicationForm.reset();
        currentAppIdInput.value = '';
        assetsList.clear();
        suppliersList.clear();
        guarantorsList.clear();
        pledgesList.clear();
        assetsList.add();
        suppliersList.add();
        guarantorsList.add();
    });

    applicationsListEl.addEventListener('click', async (e) => {
        const target = e.target;
        const appId = target.closest('[data-id]')?.dataset.id;

        if (!appId) return;

        if (target.classList.contains('delete-app-btn')) {
            if (confirm('Вы уверены, что хотите удалить эту заявку?')) {
                try {
                    const response = await fetch(`/api/applications/${appId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Ошибка удаления');
                    await renderApplicationsList();
                    if (currentAppIdInput.value === appId) newBtn.click();
                } catch (error) {
                    alert(error.message);
                }
            }
        } else {
            try {
                const response = await fetch(`/api/applications/${appId}`);
                if (!response.ok) throw new Error('Не удалось загрузить заявку');
                const data = await response.json();
                populateForm(data);
                currentAppIdInput.value = appId;
            } catch (error) {
                alert(error.message);
            }
        }
    });

    applicationForm.addEventListener('input', (e) => {
        if (e.target.name && (e.target.name.includes('total_cost') || e.target.name.includes('market_value'))) {
            e.target.value = formatNumberWithSpaces(e.target.value);
        }
        clearTimeout(autosaveTimeout);
        autosaveStatusEl.textContent = 'Есть несохраненные изменения...';
        autosaveTimeout = setTimeout(() => saveBtn.click(), 10000);
    });

    applicationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = collectPayload();
        try {
            const response = await fetch('/api/documents/generate/application', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const error = await response.json(); throw new Error(error.detail || 'Ошибка на сервере'); }
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            const disposition = response.headers.get('Content-Disposition');
            let filename = `Заявка_${payload.lessee_inn}.docx`;
            if (disposition && disposition.indexOf('attachment') !== -1) {
                const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                const matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                  filename = decodeURIComponent(matches[1].replace(/['"]/g, ''));
                }
            }
            a.setAttribute('download', filename);

            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            alert(`Ошибка при формировании файла: ${error.message}`);
        }
    });

    renderApplicationsList();
    newBtn.click();

});
</script>
{% endblock %}
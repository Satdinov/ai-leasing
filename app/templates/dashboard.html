{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <!-- –ú–µ–Ω—é -->
    <div class="md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-4">–ú–µ–Ω—é</h2>
        <ul class="space-y-2">
            <li><a href="/dashboard" class="block px-3 py-2 rounded-md bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-100">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="/upload" class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</a></li>
            <li><a href="/files" class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">–ú–æ–∏ —Ñ–∞–π–ª—ã</a></li>
        </ul>
    </div>

    <!-- –ß–∞—Ç—ã -->
    <div class="md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-4">–ß–∞—Ç—ã</h2>
        <button onclick="createChat()" class="mb-2 bg-green-500 text-white px-3 py-1 rounded-md">‚ûï –ù–æ–≤—ã–π —á–∞—Ç</button>
        <ul id="chats" class="space-y-2"></ul>
    </div>

    <!-- –ß–∞—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="md:col-span-2" id="chat-panel" style="display: none">
        <div id="messages" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 h-96 overflow-y-auto">
            <h2 class="text-xl font-semibold mb-4">–°–æ–æ–±—â–µ–Ω–∏—è</h2>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <div class="mb-4">
                <label for="model" class="block text-sm font-medium mb-1">–ú–æ–¥–µ–ª—å</label>
                <select id="model" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                    <option value="chatgpt">ChatGPT</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="gemini">Gemini</option>
                </select>
            </div>

            <textarea id="input" rows="3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 mb-2" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
            <div class="flex gap-2">
                <button id="send-btn" onclick="sendMessage()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-md">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button id="reset-btn" onclick="resetContext()" class="bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md ml-2">–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç</button>
                <button id="cancel-btn" onclick="cancelRequest()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md hidden">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentChatId = null;
let currentController = null;

async function loadChats() {
    const res = await fetch('/chats');
    const chats = await res.json();
    const list = document.getElementById('chats');
    list.innerHTML = '';
    chats.forEach(chat => {
        const li = document.createElement('li');
        li.className = 'cursor-pointer px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 bg-gray-50 dark:bg-gray-900';
        li.textContent = chat.title;
        li.onclick = () => openChat(chat.id);
        list.appendChild(li);
    });
}

async function createChat() {
    const title = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:");
    if (!title) return;
    const res = await fetch('/chats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ title })
    });
    const chat = await res.json();
    await loadChats();
    await openChat(chat.chat_id);
}

async function openChat(chatId) {
    currentChatId = chatId;
    document.getElementById('chat-panel').style.display = 'block';
    const res = await fetch(`/chats/${chatId}/messages`);
    const messages = await res.json();
    messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));  // <-- –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
    const box = document.getElementById('messages');
    box.innerHTML = '';
    messages.forEach(m => {
        const div = document.createElement('div');
        div.className = m.sender === 'user' ? 'text-right mb-4' : 'text-left mb-4';
        const bubble = document.createElement('div');
        bubble.className = 'inline-block max-w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700';
        bubble.innerHTML = `<div class="prose dark:prose-invert">${m.html_content || m.content}</div>`;
        div.appendChild(bubble);
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
}

function cancelRequest() {
    if (currentController) {
        currentController.abort();
        currentController = null;
        document.getElementById('cancel-btn').classList.add('hidden');
        document.getElementById('send-btn').disabled = false;
    }
}

async function sendMessage() {
    const input = document.getElementById('input');
    const message = input.value;
    const model = document.getElementById('model').value;
    if (!message || !currentChatId) return;

    const box = document.getElementById('messages');

    // üë§ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É
    const userDiv = document.createElement('div');
    userDiv.className = 'text-right mb-4';
    const userBubble = document.createElement('div');
    userBubble.className = 'inline-block max-w-full px-4 py-2 rounded-lg bg-blue-200 dark:bg-blue-700 text-blue-900 dark:text-blue-100';
    userBubble.innerHTML = `<div class="prose dark:prose-invert">${message}</div>`;
    userDiv.appendChild(userBubble);
    box.appendChild(userDiv);
    box.scrollTop = box.scrollHeight;

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    input.value = '';

    // –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'text-left mb-4';
    loadingDiv.id = 'loading-message';
    loadingDiv.innerHTML = '<div class="inline-block max-w-full px-4 py-2 rounded-lg bg-yellow-100 dark:bg-yellow-800 text-yellow-900 dark:text-yellow-100 animate-pulse">–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç...</div>';
    box.appendChild(loadingDiv);
    box.scrollTop = box.scrollHeight;

    const controller = new AbortController();
    currentController = controller;

    document.getElementById('send-btn').disabled = true;
    document.getElementById('cancel-btn').classList.remove('hidden');

    try {
        const res = await fetch(`/chats/${currentChatId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ message, model }),
            signal: controller.signal
        });

        if (!res.ok) {
            const errorData = await res.json();
            let errMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
            if (res.status === 402 && errorData?.error?.message) {
                errMsg = errorData.error.message;
            } else if (errorData?.error?.message) {
                errMsg = errorData.error.message;
            }

            // –£–¥–∞–ª–∏—Ç—å "–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç..."
            const loading = document.getElementById('loading-message');
            if (loading) loading.remove();

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∫–∞–∫ –æ—Ç –∞–≥–µ–Ω—Ç–∞
            const agentDiv = document.createElement('div');
            agentDiv.className = 'text-left mb-4';
            const agentBubble = document.createElement('div');
            agentBubble.className = 'inline-block max-w-full px-4 py-2 rounded-lg bg-red-200 dark:bg-red-800 text-red-900 dark:text-red-100';
            agentBubble.innerHTML = `<div class="prose dark:prose-invert">${errMsg}</div>`;
            agentDiv.appendChild(agentBubble);
            box.appendChild(agentDiv);
            box.scrollTop = box.scrollHeight;

            throw new Error(errMsg);
        }

        const data = await res.json();
        document.getElementById('input').value = '';

        // –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
        setTimeout(() => openChat(currentChatId), 1000); // –ª–∏–±–æ —á—É—Ç—å –ø–æ–∑–∂–µ

        // –£–¥–∞–ª—è–µ–º "–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç..."
        const loading = document.getElementById('loading-message');
        if (loading) loading.remove();

        // üëá –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
        const agentDiv = document.createElement('div');
        agentDiv.className = 'text-left mb-4';
        const agentBubble = document.createElement('div');
        agentBubble.className = 'inline-block max-w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-black dark:text-white';
        agentBubble.innerHTML = `<div class="prose dark:prose-invert">${data.html_content || data.content}</div>`;
        agentDiv.appendChild(agentBubble);
        box.appendChild(agentDiv);

        box.scrollTop = box.scrollHeight;
    } catch (error) {
        console.warn('–ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞:', error);
        const loading = document.getElementById('loading-message');
        if (loading) loading.innerHTML = '<div class="text-red-500">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞</div>';
    } finally {
        document.getElementById('cancel-btn').classList.add('hidden');
        document.getElementById('send-btn').disabled = false;
        currentController = null;
    }
}

async function resetContext() {
    if (!currentChatId) return;

    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —ç—Ç–æ–≥–æ —á–∞—Ç–∞? –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.")) {
        return;
    }

    try {
        const res = await fetch(`/chats/${currentChatId}/reset`, {
            method: 'POST'
        });

        if (!res.ok) {
            const error = await res.json();
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            return;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
        const box = document.getElementById('messages');
        box.innerHTML = '<h2 class="text-xl font-semibold mb-4">–°–æ–æ–±—â–µ–Ω–∏—è</h2><div class="italic text-gray-500">–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±—Ä–æ—à–µ–Ω, –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.</div>';

    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ' + e.message);
    }
}

// init
loadChats();
</script>
{% endblock %}
